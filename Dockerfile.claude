FROM python:3.13.7-alpine3.22

# Install system dependencies
RUN apk add --no-cache \
    build-base curl git nano wget procps htop \
    bash bash-completion nodejs npm

# Create non-root user
RUN adduser --disabled-password --gecos '' clco

WORKDIR /app

# Copy project files with correct ownership
COPY --chown=clco:clco . .
COPY --chown=clco:clco bashrc.additions /tmp/

# Switch to non-root user
USER clco

# Configure npm for user-space global installs
ENV NPM_CONFIG_PREFIX=/home/clco/.npm-global
ENV PATH=$NPM_CONFIG_PREFIX/bin:$PATH
RUN mkdir -p ~/.npm-global

# Install Python and Node dependencies
RUN pip install --user -e . && \
    npm install -g @anthropic-ai/claude-code

# Setup shell environment (combined into single layer)
RUN cat /tmp/bashrc.additions >> ~/.bashrc

CMD ["bash"]
